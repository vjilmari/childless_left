---
title: "RQ1, RQ2, ERQ1, ERQ2"
output: 
  html_document: 
    toc: yes
    keep_md: yes
date: '2022-05-02'
---


```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Preregistration available From: https://osf.io/er4v5

RQ1. Is childlessness associated with the three Chapel Hill rated political ideology (Left-Right, Economic Left-Right, GAL-TAN) positions of the party for which one has voted? 

H1. Regarding GAL-TAN, we expect childless people to have voted closer to the GAL pole of the dimension.

RQ2. If, as expected (H1), childlessness is associated with the GAL-TAN ideology position of the party for which one has voted, are those associations stronger if this dimension is salient in the party’s public stance (i.e., is there a boundary condition to these associations, such that the ideology needs to be salient in order for the association to exist)?

H2. We expect the association between childlessness and the GAL-TAN political ideology of the party for which one has voted to be stronger if this dimension is salient in the party’s public stance.



# Preparations

## Packages

```{r}

library(lme4)
library(emmeans)
library(rio)
library(dplyr)
library(vjihelpers)
library(ggplot2)
library(MetBrewer)
library(tibble)
library(Hmisc)

```

## Custom functions

```{r}
source("../custom_functions.R")

```

## Data

```{r}
fdat<-import("../../data/processed/fdat.xlsx")
```

## Data exclusions

```{r}

exdat<-fdat %>%
  dplyr::select(childlessness,
                gndr.f,agea,minority,
                gndr.c,age10.c,minority.c,
                lrgen,
                lrecon,galtan,
                lrecon_salience,galtan_salience,
                cntry,
                anweight) %>%
  na.omit()
```

## Variable centering

```{r}
exdat<-
  group_mean_center(
    data=exdat,group.var="cntry",
    vars=c("lrgen","lrecon","galtan",
           "lrecon_salience","galtan_salience"),
    grand.init = F)

```

## Variable scaling

```{r}
CHES<-
  import("../../data/raw/2014_CHES_dataset_means.csv")

(sd.lrgen<-sd(CHES$lrgen,na.rm=T))
(sd.lrecon<-sd(CHES$lrecon,na.rm=T))
(sd.galtan<-sd(CHES$galtan,na.rm=T))
(sd.galtan_salience<-sd(CHES$galtan_salience,na.rm=T))
(sd.lrecon_salience<-sd(CHES$lrecon_salience,na.rm=T))

exdat$lrgen.z.gmc<-exdat$lrgen.gmc/sd.lrgen
exdat$lrecon.z.gmc<-exdat$lrecon.gmc/sd.lrecon
exdat$galtan.z.gmc<-exdat$galtan.gmc/sd.galtan
exdat$galtan_salience.z.gmc<-
  exdat$galtan_salience.gmc/sd.galtan_salience
exdat$lrecon_salience.z.gmc<-
  exdat$lrecon_salience.gmc/sd.lrecon_salience
```

# RQ1 Analysis 


RQ1. Is childlessness associated with the three Chapel Hill rated political ideology (Left-Right, Economic Left-Right, GAL-TAN) positions of the party for which one has voted? 

H1. Regarding GAL-TAN, we expect childless people to have voted closer to the GAL pole of the dimension.

## Baserate only


```{r}
mod0<-
  glmer(childlessness~(1|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight)

summary(mod0)

export(rownames_to_column(
  getFE_glmer(mod0,round = 10,p.round=10)),
       "../../results/estimates/FE_mod0.xlsx",
       overwrite=T)

export(getVC(mod0,round = 10),
       "../../results/estimates/VC_mod0.xlsx",
       overwrite=T)


```

## Covariates

```{r}
mod1<-
  glmer(childlessness~gndr.c+age10.c+minority.c+(1|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight)

summary(mod1)

export(rownames_to_column(
  getFE_glmer(mod1,round = 10,p.round=10)),
       "../../results/estimates/FE_mod1.xlsx",
       overwrite=T)

export(getVC(mod1,round = 10),
       "../../results/estimates/VC_mod1.xlsx",
       overwrite=T)
```

## lrgen

### Fixed

```{r}
mod2.lrgen<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          lrgen.z.gmc+
          (1|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight)
summary(mod2.lrgen)

export(rownames_to_column(
  getFE_glmer(mod2.lrgen,round = 10,p.round=10)),
       "../../results/estimates/FE_mod2.lrgen.xlsx",
       overwrite=T)

export(getVC(mod2.lrgen,round = 10),
       "../../results/estimates/VC_mod2.lrgen.xlsx",
       overwrite=T)
```

### Random

```{r}
mod3.lrgen<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          lrgen.z.gmc+
          (lrgen.z.gmc|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod3.lrgen)

anova(mod2.lrgen,mod3.lrgen)

export(rownames_to_column(
  getFE_glmer(mod3.lrgen,round = 10,p.round=10)),
       "../../results/estimates/FE_mod3.lrgen.xlsx",
       overwrite=T)

export(getVC(mod3.lrgen,round = 10),
       "../../results/estimates/VC_mod3.lrgen.xlsx",
       overwrite=T)
```


### Random without random effect correlation

```{r}
mod4.lrgen<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          lrgen.z.gmc+
          (lrgen.z.gmc||cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod4.lrgen)

anova(mod2.lrgen,mod4.lrgen)
anova(mod4.lrgen,mod3.lrgen)

export(rownames_to_column(
  getFE_glmer(mod4.lrgen,round = 10,p.round=10)),
       "../../results/estimates/FE_mod4.lrgen.xlsx",
       overwrite=T)

export(getVC(mod4.lrgen,round = 10),
       "../../results/estimates/VC_mod4.lrgen.xlsx",
       overwrite=T)
```


## lrecon

### Fixed

```{r}
mod2.lrecon<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          lrecon.z.gmc+
          (1|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight)
summary(mod2.lrecon)

export(rownames_to_column(
  getFE_glmer(mod2.lrecon,round = 10,p.round=10)),
       "../../results/estimates/FE_mod2.lrecon.xlsx",
       overwrite=T)

export(getVC(mod2.lrecon,round = 10),
       "../../results/estimates/VC_mod2.lrecon.xlsx",
       overwrite=T)
```

### Random

```{r}
mod3.lrecon<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          lrecon.z.gmc+
          (lrecon.z.gmc|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod3.lrecon)

anova(mod2.lrecon,mod3.lrecon)

export(rownames_to_column(
  getFE_glmer(mod3.lrecon,round = 10,p.round=10)),
       "../../results/estimates/FE_mod3.lrecon.xlsx",
       overwrite=T)

export(getVC(mod3.lrecon,round = 10),
       "../../results/estimates/VC_mod3.lrecon.xlsx",
       overwrite=T)
```


### Random without random effect correlation

```{r}
mod4.lrecon<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          lrecon.z.gmc+
          (lrecon.z.gmc||cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod4.lrecon)

anova(mod2.lrecon,mod4.lrecon)
anova(mod4.lrecon,mod3.lrecon)

export(rownames_to_column(
  getFE_glmer(mod4.lrecon,round = 10,p.round=10)),
       "../../results/estimates/FE_mod4.lrecon.xlsx",
       overwrite=T)

export(getVC(mod4.lrecon,round = 10),
       "../../results/estimates/VC_mod4.lrecon.xlsx",
       overwrite=T)
```





## galtan

### Fixed

```{r}
mod2.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+
          (1|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight)
summary(mod2.galtan)

export(rownames_to_column(
  getFE_glmer(mod2.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod2.galtan.xlsx",
       overwrite=T)

export(getVC(mod2.galtan,round = 10),
       "../../results/estimates/VC_mod2.galtan.xlsx",
       overwrite=T)
```

### Random

```{r}
mod3.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+
          (galtan.z.gmc|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod3.galtan)

anova(mod2.galtan,mod3.galtan)

export(rownames_to_column(
  getFE_glmer(mod3.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod3.galtan.xlsx",
       overwrite=T)

export(getVC(mod3.galtan,round = 10),
       "../../results/estimates/VC_mod3.galtan.xlsx",
       overwrite=T)
```


### Random without random effect correlation

```{r}
mod4.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+
          (galtan.z.gmc||cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod4.galtan)

anova(mod2.galtan,mod4.galtan)
anova(mod4.galtan,mod3.galtan)

export(rownames_to_column(
  getFE_glmer(mod4.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod4.galtan.xlsx",
       overwrite=T)

export(getVC(mod4.galtan,round = 10),
       "../../results/estimates/VC_mod4.galtan.xlsx",
       overwrite=T)
```



# RQ2 Analysis 

RQ2. If, as expected (H1), childlessness is associated with the GAL-TAN ideology position of the party for which one has voted, are those associations stronger if this dimension is salient in the party’s public stance (i.e., is there a boundary condition to these associations, such that the ideology needs to be salient in order for the association to exist)?

H2. We expect the association between childlessness and the GAL-TAN political ideology of the party for which one has voted to be stronger if this dimension is salient in the party’s public stance.

## galtan salience fixed main effect

```{r}
mod5.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+galtan_salience.z.gmc+
          (1|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa"))
summary(mod5.galtan)

export(rownames_to_column(
  getFE_glmer(mod5.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod5.galtan.xlsx",
       overwrite=T)

export(getVC(mod5.galtan,round = 10),
       "../../results/estimates/VC_mod5.galtan.xlsx",
       overwrite=T)
```

## galtan salience random main effect

```{r}
mod6.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+galtan_salience.z.gmc+
          (galtan_salience.z.gmc|cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa"))
summary(mod6.galtan)
anova(mod5.galtan,mod6.galtan)

export(rownames_to_column(
  getFE_glmer(mod6.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod6.galtan.xlsx",
       overwrite=T)

export(getVC(mod6.galtan,round = 10),
       "../../results/estimates/VC_mod6.galtan.xlsx",
       overwrite=T)
```

## galtan salience random main effect without random effect correlation

```{r}
mod7.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+galtan_salience.z.gmc+
          (galtan_salience.z.gmc||cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa"))
summary(mod7.galtan)
anova(mod5.galtan,mod7.galtan)
anova(mod7.galtan,mod6.galtan)

export(rownames_to_column(
  getFE_glmer(mod7.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod7.galtan.xlsx",
       overwrite=T)

export(getVC(mod7.galtan,round = 10),
       "../../results/estimates/VC_mod7.galtan.xlsx",
       overwrite=T)
```

## fixed interaction between galtan and galtan salience

```{r}
mod8.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+galtan_salience.z.gmc+
          galtan.z.gmc:galtan_salience.z.gmc+
          (galtan_salience.z.gmc||cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod8.galtan)

export(rownames_to_column(
  getFE_glmer(mod8.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod8.galtan.xlsx",
       overwrite=T)

export(getVC(mod8.galtan,round = 10),
       "../../results/estimates/VC_mod8.galtan.xlsx",
       overwrite=T)

```

### marginal effects

```{r}
emtrends(mod8.galtan,
         var="galtan.z.gmc",
         specs="galtan_salience.z.gmc",
         at=list(galtan_salience.z.gmc=c(-1,0,1)),
         infer=c(T,T))

round(exp(c(0.12151,0.00645,0.2366)),2)
round(exp(c(0.00607,-0.05188,0.0640)),2)
round(exp(c(-0.10936,-0.17848,-0.0402)),2)

```



## random interaction between galtan and galtan salience

```{r}
mod9.galtan<-
  glmer(childlessness~gndr.c+age10.c+minority.c+
          galtan.z.gmc+galtan_salience.z.gmc+
          galtan.z.gmc:galtan_salience.z.gmc+
          (galtan_salience.z.gmc+
             galtan.z.gmc:galtan_salience.z.gmc||cntry),
        data=exdat,
        family=binomial(link="logit"),weights = anweight,
        control = glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e6)))
summary(mod9.galtan)
anova(mod8.galtan,mod9.galtan)

export(rownames_to_column(
  getFE_glmer(mod9.galtan,round = 10,p.round=10)),
       "../../results/estimates/FE_mod9.galtan.xlsx",
       overwrite=T)

export(getVC(mod9.galtan,round = 10),
       "../../results/estimates/VC_mod9.galtan.xlsx",
       overwrite=T)
```



### Plot

```{r}

p<-
  emmip(mod8.galtan, galtan_salience.z.gmc ~ galtan.z.gmc,
        at=list(galtan_salience.z.gmc = c(-1,0,1),
                #minority.c = c(-0.5,0.5),
                galtan.z.gmc=seq(from=-2,to=2,by=0.01)),
        plotit=F,CIs=TRUE,type="response")

head(p)

#p$ethnic_minority=
#  ifelse(p$minority.c==(-0.5),
#         "Ethnic majority","Ethnic minority")
p$galtan_salience<-p$tvar
levels(p$galtan_salience)<-c("Low Salience","Average Salience","High Salience")


min.low<-
  min(exdat[exdat$galtan_salience.z.gmc<=(-1),
            "galtan.z.gmc"])
max.low<-
  max(exdat[exdat$galtan_salience.z.gmc<=(-1),
            "galtan.z.gmc"])


p$filter.low<-
  ifelse(p$galtan_salience.z.gmc==(-1) &
           (p$galtan.z.gmc<min.low | 
              p$galtan.z.gmc>max.low),0,1)

table(p$filter.low)

min.mid<-
  min(exdat[exdat$galtan_salience.z.gmc>(-1) |
              exdat$galtan_salience.z.gmc<(1),
            "galtan.z.gmc"])
max.mid<-
  max(exdat[exdat$galtan_salience.z.gmc>(-1) |
              exdat$galtan_salience.z.gmc<(1),
            "galtan.z.gmc"])


p$filter.mid<-
  ifelse(p$galtan_salience.z.gmc==(0) &
           (p$galtan.z.gmc<min.mid | 
              p$galtan.z.gmc>max.mid),0,1)

table(p$filter.mid)

min.high<-
  min(exdat[exdat$galtan_salience.z.gmc>=(1) ,
            "galtan.z.gmc"])
max.high<-
  max(exdat[exdat$galtan_salience.z.gmc>=(1) ,
            "galtan.z.gmc"])



p$filter.high<-
  ifelse(p$galtan_salience.z.gmc==(1) &
           (p$galtan.z.gmc<min.high | 
              p$galtan.z.gmc>max.high),0,1)

table(p$filter.high)

p.ex<-p[p$filter.low!=0 & p$filter.mid!=0 & p$filter.high!=0,]

met.brewer("Archambault")
met.brewer("Archambault")[c(1,3,2)]

p1<-ggplot(p.ex,aes(y=yvar,x=xvar,color=galtan_salience))+
  geom_point(size=3)+
  geom_errorbar(aes(ymin=LCL, ymax=UCL),alpha=0.5)+
  xlab("GAL-TAN")+
  ylab("P(Childlessness)")+
  scale_color_manual(values=met.brewer("Archambault")[c(1,3,2)])+
  facet_wrap(~galtan_salience,ncol=3)+
  theme(legend.position = "none",
        text=element_text(size=16,  family="sans"),
        panel.background = element_rect(fill = "white",
                                        #colour = "black",
                                        #size = 0.5, linetype = "solid"
                                        ),
        panel.grid.major.x = element_line(size = 0.5, linetype = 2,
                                        colour = "black"))
p1

png(filename = 
      "results/figures/Figure 1.png",
    units = "cm",
    #width = 29.7,height=21.0,
    width = 18.0,height=18/(29.7/21),
    res = 2000)
p1
dev.off()

```


### marginal effects

```{r}
emtrends(mod6.galtan,
         var="galtan.z.gmc",
         specs="galtan_salience.z.gmc",
         at=list(galtan_salience.z.gmc=c(-1,0,1)),infer=c(T,T))
```


# Session Information

```{r}
sinf<-sessionInfo()
print(sinf,locale=F)
```
